<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Al-Atrash üéµ ‚Äî Your Oud Chatbot</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
:root {
  --gold: #e0b36a;
  --deep-gold: #9c6b2f;
  --dark: #0f0d0b;
  --panel: rgba(28, 23, 18, 0.85);
  --glass: rgba(255,255,255,0.06);
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Cairo', sans-serif;
  background:
    radial-gradient(circle at 20% 10%, rgba(224,179,106,0.15), transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(156,107,47,0.18), transparent 55%),
    linear-gradient(180deg, #0b0a08, #15120e);
  min-height: 100vh;
  margin: 0;
  padding: 40px 10px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  color: #eee;
  overflow: hidden;
}

/* floating oud-string lines */
body::before {
  content: "";
  position: absolute;
  inset: 0;
  background:
    repeating-linear-gradient(
      90deg,
      transparent,
      transparent 48px,
      rgba(224,179,106,0.04) 50px
    );
  animation: strings 25s linear infinite;
  pointer-events: none;
}

@keyframes strings {
  from { transform: translateX(0); }
  to { transform: translateX(50px); }
}

#connecting {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle, rgba(0,0,0,0.9), #000);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  letter-spacing: 2px;
  color: var(--gold);
  z-index: 999;
}

#chat-container {
  display: none;
  z-index: 2;
  animation: rise 0.8s cubic-bezier(.16,.84,.44,1) forwards;
}

@keyframes rise {
  from { opacity: 0; transform: translateY(40px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

#chat {
  width: 460px;
  background: var(--panel);
  border-radius: 28px;
  box-shadow:
    0 30px 80px rgba(0,0,0,0.7),
    inset 0 0 0 1px rgba(224,179,106,0.35);
  overflow: hidden;
  backdrop-filter: blur(14px);
}

/* HEADER */
.header {
  position: relative;
  background:
    radial-gradient(circle at left, rgba(224,179,106,0.25), transparent 60%),
    linear-gradient(135deg, #1a140e, #2a1f14);
  padding: 22px;
  display: flex;
  gap: 14px;
  align-items: center;
  border-bottom: 1px solid rgba(224,179,106,0.25);
}

.header::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 20px;
  right: 20px;
  height: 1px;
  background: linear-gradient(to right, transparent, var(--gold), transparent);
}

.header img {
  width: 58px;
  height: 58px;
  border-radius: 50%;
  border: 2px solid var(--gold);
  box-shadow:
    0 0 0 4px rgba(224,179,106,0.15),
    0 10px 25px rgba(0,0,0,0.8);
}

.header div div:first-child {
  font-weight: 700;
  font-size: 18px;
  color: var(--gold);
  letter-spacing: 0.5px;
}

.small {
  font-size: 12px;
  opacity: 0.85;
}

/* MESSAGES */
#messages {
  height: 520px;
  padding: 22px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 14px;
  background:
    radial-gradient(circle at top, rgba(255,255,255,0.03), transparent 60%);
}

.bubble {
  max-width: 78%;
  padding: 14px 16px;
  border-radius: 20px;
  line-height: 1.6;
  font-size: 15px;
  animation: appear 0.35s ease forwards;
  opacity: 0;
}

@keyframes appear {
  from { transform: translateY(8px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.bot {
  align-self: flex-start;
  background:
    linear-gradient(135deg, rgba(224,179,106,0.18), rgba(255,255,255,0.04));
  border-left: 3px solid var(--gold);
  box-shadow: 0 8px 18px rgba(0,0,0,0.4);
}

.user {
  align-self: flex-end;
  background:
    linear-gradient(135deg, rgba(120,200,150,0.25), rgba(255,255,255,0.05));
  border-right: 3px solid #7fd1a2;
  box-shadow: 0 8px 18px rgba(0,0,0,0.4);
}

/* INPUT */
.input {
  display: flex;
  gap: 10px;
  padding: 16px;
  background: linear-gradient(180deg, #1a140e, #120f0c);
  border-top: 1px solid rgba(224,179,106,0.25);
}

.input input {
  flex: 1;
  background: rgba(0,0,0,0.4);
  border: 1px solid rgba(224,179,106,0.4);
  border-radius: 14px;
  padding: 12px 14px;
  color: #fff;
  font-size: 15px;
  outline: none;
}

.input input::placeholder {
  color: rgba(255,255,255,0.4);
}

.input input:focus {
  box-shadow: 0 0 0 3px rgba(224,179,106,0.25);
}

.input button {
  background: linear-gradient(135deg, var(--deep-gold), var(--gold));
  border: none;
  border-radius: 14px;
  padding: 12px 22px;
  color: #000;
  font-weight: 700;
  cursor: pointer;
  transition: 0.3s;
}

.input button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(224,179,106,0.6);
}

/* TYPING */
.typing {
  display: flex;
  gap: 6px;
  padding: 12px 16px;
  background: rgba(224,179,106,0.15);
  border-radius: 16px;
}

.typing span {
  width: 8px;
  height: 8px;
  background: var(--gold);
  border-radius: 50%;
  animation: pulse 1.4s infinite ease-in-out;
}

.typing span:nth-child(2) { animation-delay: .2s; }
.typing span:nth-child(3) { animation-delay: .4s; }

@keyframes pulse {
  0%,100% { transform: scale(1); opacity: .4; }
  50% { transform: scale(1.5); opacity: 1; }
}
</style>

</head>

<body>
  <div id="connecting">üéµ Connecting to Al-Atrash...</div>

  <div id="chat-container">
    <div id="chat">
      <div class="header">
        <img src="static/Farid.png" alt="Al-Atrash">
        <div>
          <div style="font-weight:700; font-size:17px;">Al-Atrash üéµ</div>
          <div class="small">Your Oud Learning Guide</div>
        </div>
      </div>

      <div id="messages"></div>

      <div class="input">
        <input id="msg" placeholder="Ask me about the Oud..." />
        <button id="send">Send</button>
      </div>
    </div>
  </div>

  <script>
    const SENDER = localStorage.getItem("senderId") || "web_user_" + Date.now();
    localStorage.setItem("senderId", SENDER);

    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('msg');
    const sendBtn = document.getElementById('send');

    function appendMessage(text, sender='bot') {
      const el = document.createElement('div');
      el.className = 'bubble ' + (sender==='bot' ? 'bot' : 'user');
      el.innerHTML = text.replace(/\n/g, "<br/>");
      messagesDiv.appendChild(el);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Typing animation
    function showTyping() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing';
      typingDiv.innerHTML = '<span></span><span></span><span></span>';
      typingDiv.id = 'typing';
      messagesDiv.appendChild(typingDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function hideTyping() {
      const t = document.getElementById('typing');
      if (t) t.remove();
    }

    async function sendMessage(text) {
      appendMessage(text, 'user');
      showTyping();
      try {
        const resp = await fetch('http://127.0.0.1:8000/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ sender: SENDER, message: text })
        });
        const data = await resp.json();
        hideTyping();
        if (data && data.responses) {
          for (const r of data.responses) {
            setTimeout(() => appendMessage(r, 'bot'), 300);
          }
        } else appendMessage("No response from server.", 'bot');
      } catch (err) {
        hideTyping();
        appendMessage("‚ö†Ô∏è Unable to reach backend. Please make sure it's running.", 'bot');
      }
    }

    sendBtn.onclick = () => {
      const t = input.value.trim();
      if (!t) return;
      sendMessage(t);
      input.value = '';
    };

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); sendBtn.click(); }
    });

    window.onload = async () => {
    try {
        const response = await fetch('http://127.0.0.1:8000/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({sender: SENDER, message: ""})
        });

        const data = await response.json();

        // Hide "Connecting..." and show chat
        document.getElementById('connecting').style.display = 'none';
        document.getElementById('chat-container').style.display = 'flex';

        if (data && data.responses) {
          for (const r of data.responses) {
            await new Promise(res => setTimeout(res, 500)); // 0.5s delay
            appendMessage(r, 'bot');
        } }
        else {
            appendMessage("‚ö†Ô∏è No response from server.", 'bot');
        }

    } catch (err) {
        document.getElementById('connecting').innerText =
            "‚ö†Ô∏è Unable to connect to backend. Please make sure it's running.";
        console.error(err);
    }
};


  </script>
</body>
</html>
